# 钉钉机器人配置指南

## 1. 创建钉钉机器人

### 步骤1：进入群设置
1. 打开钉钉，进入要接收通知的群
2. 点击右上角的群设置图标
3. 选择「智能群助手」

### 步骤2：添加机器人
1. 点击「添加机器人」
2. 选择「自定义」机器人
3. 点击「添加」

### 步骤3：配置机器人
1. **设置机器人名称**：例如"MT5交易助手"
2. **选择安全设置**（三选一）：
   - **自定义关键词**：消息中必须包含关键词（如"交易"）
   - **加签**：使用密钥进行安全验证（推荐）
   - **IP地址**：只允许指定IP发送

3. **推荐使用加签方式**：
   - 勾选「加签」
   - 系统会生成一个密钥，格式如：`SEC...`
   - 复制并保存这个密钥

4. **完成创建**：
   - 点击「完成」
   - 复制生成的Webhook地址

## 2. 配置系统

在 `config/settings.py` 中添加配置：

```python
# 钉钉机器人配置
DINGTALK_WEBHOOK = "https://oapi.dingtalk.com/robot/send?access_token=你的access_token"
DINGTALK_SECRET = "SEC开头的加签密钥"  # 如果选择了加签方式
```

## 3. 测试配置

1. 启动交易系统
2. 选择菜单选项 16「测试钉钉通知」
3. 发送测试消息验证配置是否正确

## 4. 通知类型说明

### 交易通知
- **开仓通知**：包含品种、方向、价格、数量、策略
- **平仓通知**：额外包含盈亏信息
- **示例**：
  ```
  🔔 交易通知
  时间: 2024-01-15 10:30:45
  品种: BTCUSD
  动作: 开仓成功
  方向: BUY
  价格: 45000.50
  数量: 0.01
  策略: 双均线策略
  ```

### 每日报告
- **内容**：当日交易统计、盈亏分析、各币种表现
- **发送时间**：可配置，建议每日收盘后
- **@所有人**：重要报告会@所有人

### 风险警告
- **触发条件**：
  - 单笔亏损超过限制
  - 总风险超过阈值
  - 可用保证金不足
- **处理建议**：提供具体的风险控制建议

### 参数优化通知
- **内容**：优化结果、最佳参数、预期表现
- **自动应用**：显示是否已应用新参数

## 5. 注意事项

1. **消息频率**：
   - 避免发送过于频繁的消息
   - 建议只发送重要通知

2. **安全性**：
   - 不要泄露webhook地址和密钥
   - 定期更换机器人密钥

3. **群管理**：
   - 建议创建专门的交易通知群
   - 只邀请相关人员加入

4. **消息格式**：
   - 系统使用Markdown格式
   - 支持颜色、加粗等样式

## 6. 常见问题

### Q1: 收不到通知怎么办？
1. 检查webhook地址是否正确
2. 确认密钥配置正确
3. 查看程序日志中的错误信息
4. 测试网络连接是否正常

### Q2: 如何修改通知内容？
可以修改 `notifications/dingtalk.py` 中的相应方法来自定义通知格式。

### Q3: 如何控制通知频率？
在交易逻辑中添加条件判断，只在重要事件时发送通知。

### Q4: 支持其他通知方式吗？
目前只支持钉钉，但架构设计支持扩展其他通知方式（如微信、邮件等）。